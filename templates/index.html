<!DOCTYPE html>
<html>
<head>
  <title>Risk Matrix</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 30px;
    }

    h2 {
      margin-top: 0;
    }

    .card {
      background: white;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    input, select {
      padding: 6px;
      margin: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button.primary {
      background: #007bff;
      color: white;
    }

    button.success {
      background: #28a745;
      color: white;
    }

    button.warning {
      background: #ffc107;
    }

    button.danger {
      background: #dc3545;
      color: white;
    }

    table {
    table-layout: fixed;
    width: 100%;
}

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #f1f1f1;
    }

    .low { background: #d4edda; }
    .medium { background: #fff3cd; }
    .high { background: #f8d7da; }

    .actions a {
      margin-left: 8px;
      text-decoration: none;
      color: #dc3545;
    }
    .matrix-cell {
  vertical-align: top;
  padding: 6px;
  max-width: 160px;
  word-wrap: break-word;
  white-space: normal;
}

.matrix-cell .value {
  font-weight: bold;
  text-align: center;
  margin-bottom: 4px;
}

/* Comment text */
.matrix-cell .comment {
  font-size: 12px;
  line-height: 1.3;
  color: #333;
  white-space: pre-wrap;   /* preserves line breaks */
  word-break: break-word;
}

/* Coloring */
td.high { background-color: #ffd6d6; }
td.medium { background-color: #e6ffe6; }
td.low  { background-color: #fff5cc; }

.comment { display: none; }
.matrix-cell:hover .comment { display: block; }

.project-name {
    width: 260px;               /* fixed column width */
    max-width: 260px;
    white-space: normal;        /* allow wrapping */
    word-wrap: break-word;      /* break long words */
    overflow-wrap: break-word;  /* modern browsers */
    vertical-align: top;
}

  </style>
</head>
<body>
    <div class="card">
  <button class="primary" onclick="toggleAdd()">âž• Add Project</button>
</div>
<div class="card" id="addPanel" style="display:none">
<h2>Add Project</h2>

  <form method="post" action="/add">
   <input type="hidden" id="projectId">
<input type="text" id="groupName" name="group" list="groupList" placeholder="Enter group name ">
<input id="projectName" name="name" placeholder="Project name" required>

<datalist id="groupList">
  {% for g in groups %}
    <option value="{{ g }}">
  {% endfor %}
</datalist>

{% for d in domains %}
 
  <div class="domain-row">
       <h4>{{ d }} : {{ domaintext[loop.index0] }} - {{ domainqns [loop.index0] }} : </h4><select id="{{ d }}_value" name="{{ d }}">
      <option value="high">High Risk</option>
      <option value="low">Low Risk</option>
      <option value="medium">Unclear</option>
    </select>

    <input id="{{ d }}_comment" placeholder="Comment for {{ d }}">
  </div>
{% endfor %}
      <button type="button" onclick="saveProject()">Save</button>
  <button onclick="hideEditor()">Cancel</button>
  </form>
</div>
<div>
  <label for="groupSelect"><b>Filter by Group:</b></label>

<form method="get" action="/">
  <select id="groupSelect" name="group" onchange="this.form.submit()">
    <option value="">All Groups</option>

    {% for g in groups %}
      <option value="{{ g }}" {% if g == selected_group %}selected{% endif %}>
        {{ g }}
      </option>
    {% endfor %}
  </select>
</form>
</div>
<div class="card">
<h2>Projects</h2>

<table class="table table-bordered">
  <tr>
    <th class="project-name">Name</th>
    {% for d in domains %}<th>{{ domaintext[loop.index0] }}</th>{% endfor %}
    <th>Action</th>
  </tr>

  {% for p in projects %}
  <tr id="row-{{ p['id'] }}">
    <form method="post" action="/update/{{ p['id'] }}">
      
      <!-- Name -->
      <td>
        <span class="view">{{ p["name"] }}</span>
        <input class="edit" name="name" value="{{ p['name'] }}" hidden>
      </td>

      <!-- Domains -->
     {% for d in domains %}
  {% set v = p["values"].get(d, "low") %}
  {% set cmt = p["comments"].get(d, "") %}

  <td class="matrix-cell {{ v }}">
    <div class="value">{{ v|capitalize }}</div>

    {% if cmt %}
      <div class="comment">{{ cmt }}</div>
    {% endif %}
  </td>
{% endfor %}
      <!-- Actions -->
      <td>
        <button type="button" onclick="editProject('{{p.id}}')">Edit</button>
        <a href="/delete/{{ p['id'] }}" class="view">Delete</a>
      </td>

    </form>
  </tr>
  {% endfor %}
</table>
</div>

<!--<br>
<label for="groupSelect">Select Group:</label>
<select id="groupSelect">
  <option value="">-- All Projects --</option>

  {% for g in groups %}
    <option value="{{ g }}">{{ g }}</option>
  {% endfor %}
</select>
<br> -->
<div class="card">
  <h2>Export</h2>
  <button class="success" onclick="downloadPNG()">Download PNG</button>
  <!--<a href="/generate">
    <button class="success">Download PNG</button>
  </a>-->
  <button class="warning" onclick="downloadPDF()">Download PDF</button>
  <!--<a href="/download-pdf">
    <button class="warning">Download PDF</button>
  </a>-->
</div>
<script>
function editRow(id) {
  document.querySelectorAll(`#row-${id} .view`).forEach(e => e.hidden = true);
  document.querySelectorAll(`#row-${id} .edit`).forEach(e => e.hidden = false);
}

function cancelEdit(id) {
  document.querySelectorAll(`#row-${id} .view`).forEach(e => e.hidden = false);
  document.querySelectorAll(`#row-${id} .edit`).forEach(e => e.hidden = true);
}
function toggleAdd() {
  const panel = document.getElementById("addPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}
function editProject(id) {
  console.log("Editing project id:", id);

  fetch(`/project/${id}`)
    .then(r => r.json())
    .then(p => {

      if (p.error) {
        alert("Project not found");
        return;
      }

      const pid = document.getElementById("projectId");
      const pname = document.getElementById("projectName");

      if (!pid || !pname) {
        console.error("Editor elements missing in DOM");
        return;
      }

      pid.value = id;
      pname.value = p.name || "";

      ["D1","D2","D3","D4","D5","D6","D7","D8","D9"].forEach(d => {
        const v = document.getElementById(d+"_value");
        const c = document.getElementById(d+"_comment");

        if (v) v.value = p.values?.[d] || "low";
        if (c) c.value = p.comments?.[d] || "";
      });

      showEditor();
    })
    .catch(err => console.error(err));
}


function saveProject() {
  const values = {};
  const comments = {};

  ["D1","D2","D3","D4","D5","D6","D7","D8","D9"].forEach(d => {
    values[d] = document.getElementById(d+"_value").value;
    comments[d] = document.getElementById(d+"_comment").value;
  });

  fetch("/save", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      id: document.getElementById("projectId").value || null,
      name: document.getElementById("projectName").value,
      group: document.getElementById("groupName").value,
      values,
      comments
    })
  }).then(() => location.reload());
}
function showEditor() {
    document.getElementById("addPanel").style.display = "block";
  }

  function hideEditor() {
    document.getElementById("addPanel").style.display = "none";

    // clear form when closing
    document.getElementById("projectId").value = "";
    document.getElementById("projectName").value = "";

    ["D1","D2","D3","D4","D5","D6","D7","D8","D9"].forEach(d => {
      document.getElementById(d+"_value").value = "low";
      document.getElementById(d+"_comment").value = "";
    });
  }


function downloadPNG() {
  const group = document.getElementById("groupSelect").value;
  
  let url;
  if (group === "") {
    // All projects
    url = "/generate";
  } else {
    // Group-wise
    url = "/generate/" + encodeURIComponent(group);
  }

  window.open(url, "_blank");
}

function downloadPDF() {
  const group = document.getElementById("groupSelect").value;
  
  let url = "/download-pdf";

  if (group) {
    url += "?group=" + encodeURIComponent(group);
  }

  window.open(url, "_blank");
}
</script>
</body>
</html>
